blueprint:
  name: "Ajf_defi"
  description: "Automatisation avancée pour les défis Hilo avec gestion individuelle des thermostats et des équipements."
  domain: automation
  input:
    default_challenge_entity:
      name: "Entité de Défi de Hilo par défaut"
      selector:
        entity:
          domain:
          - sensor
          multiple: false
    do_pre_heat:
      name: "Activer le pré-chauffage"
      default: true
      selector:
        boolean: {}
    challenge_am:
      name: "Défi AM"
      default: true
      selector:
        boolean: {}
    challenge_pm:
      name: "Défi PM"
      default: true
      selector:
        boolean: {}
    thermostats:
      name: "Thermostats"
      selector:
        entity:
          domain:
          - climate
          multiple: true
    thermostat_temps:
      name: "Températures normales par thermostat"
      description: "Définir une température normale spécifique par thermostat."
      selector:
        entity:
          domain:
          - climate
          multiple: true
      default: {}
    reference_temp:
      name: "Température de référence (+1°C)"
      default: 1
      selector:
        number:
          min: -5
          max: 5
          step: 0.5
          unit_of_measurement: "°C"
    cooling_temp:
      name: "Température de refroidissement (-2°C)"
      default: -2
      selector:
        number:
          min: -5
          max: 5
          step: 0.5
          unit_of_measurement: "°C"
    appreciation_reference_temp:
      name: "Température de la référence d'appréciation (-2°C)"
      default: -2
      selector:
        number:
          min: -5
          max: 5
          step: 0.5
          unit_of_measurement: "°C"
    appreciation_temp:
      name: "Température d'appréciation (+2°C)"
      default: 2
      selector:
        number:
          min: -5
          max: 5
          step: 0.5
          unit_of_measurement: "°C"
    preheat_temp:
      name: "Température de préchauffage (+5°C)"
      default: 5
      selector:
        number:
          min: -5
          max: 5
          step: 0.5
          unit_of_measurement: "°C"
    challenge_temp:
      name: "Température de défi (-4°C)"
      default: -4
      selector:
        number:
          min: -5
          max: 5
          step: 0.5
          unit_of_measurement: "°C"
    water_heater:
      name: "Chauffe-eau"
      selector:
        entity:
          domain:
          - switch
          multiple: false
      default: "switch.chauffe_eau"
    bool_ref_water_heater:
      name: "Contrôle du chauffe-eau"
      default: false
      selector:
        boolean: {}
    other_devices:
      name: "Autres équipements"
      selector:
        entity:
          domain:
          - switch
          multiple: true
      default: []
    send_command:
      name: "Commande à envoyer (ex: contrôle thermopompe)"
      selector:
        text:
      default: ""
triggers:
  - platform: state
    entity_id: sensor.defi_hilo
variables:
  do_pre_heat: !input do_pre_heat
  thermostats: !input thermostats
  thermostat_temps: !input thermostat_temps
  reference_temp: !input reference_temp
  cooling_temp: !input cooling_temp
  appreciation_reference_temp: !input appreciation_reference_temp
  appreciation_temp: !input appreciation_temp
  preheat_temp: !input preheat_temp
  challenge_temp: !input challenge_temp
  water_heater: !input water_heater
  bool_ref_water_heater: !input bool_ref_water_heater
  other_devices: !input other_devices
  send_command: !input send_command
action:
  - choose:
      - conditions:
          - condition: state
            entity_id: sensor.defi_hilo
            state: pre_heat
        sequence:
          - repeat:
              for_each: "{{ thermostats }}"
              sequence:
                - service: climate.set_temperature
                  data:
                    entity_id: "{{ repeat.item }}"
                    temperature: "{{ thermostat_temps.get(repeat.item, thermostat_temps.get(repeat.item, 21) + preheat_temp) }}"
      - conditions:
          - condition: state
            entity_id: sensor.defi_hilo
            state: reduction
        sequence:
          - repeat:
              for_each: "{{ thermostats }}"
              sequence:
                - service: climate.set_temperature
                  data:
                    entity_id: "{{ repeat.item }}"
                    temperature: "{{ thermostat_temps.get(repeat.item, thermostat_temps.get(repeat.item, 21) + challenge_temp) }}"
      - conditions:
          - condition: state
            entity_id: sensor.defi_hilo
            state: "off"
        sequence:
          - repeat:
              for_each: "{{ thermostats }}"
              sequence:
                - service: climate.set_temperature
                  data:
                    entity_id: "{{ repeat.item }}"
                    temperature: "{{ thermostat_temps.get(repeat.item, 21) }}"
          - if:
              - condition: template
                value_template: "{{ bool_ref_water_heater }}"
            then:
              - service: switch.turn_on
                target:
                  entity_id: "{{ water_heater }}"
          - if:
              - condition: template
                value_template: "{{ send_command | length > 0 }}"
            then:
              - service: remote.send_command
                data:
                  command: "{{ send_command }}"
